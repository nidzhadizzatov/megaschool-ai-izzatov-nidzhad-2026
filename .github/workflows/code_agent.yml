name: Code Agent

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process_issue:
    # Run on new issues OR when someone comments @coding-agent
    if: |
      github.event_name == 'issues' || 
      (github.event_name == 'issue_comment' && 
       (contains(github.event.comment.body, '@coding-agent') || 
        contains(github.event.comment.body, '@code-agent')))
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: agent/requirements.txt
      
      - name: Install dependencies
        run: |
          cd agent
          pip install -r requirements.txt
      
      - name: Configure Git
        run: |
          git config --global user.name "Coding Agent"
          git config --global user.email "coding-agent@github.actions"
      
      - name: Get Issue Number
        id: get_issue
        run: |
          if [ "${{ github.event_name }}" == "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Process Issue with Code Agent CLI
        working-directory: agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL || 'https://api.openai.com/v1' }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPO: ${{ github.repository }}
          MAX_FIX_ITERATIONS: "3"
        run: |
          python cli.py process-issue ${{ github.repository }} ${{ steps.get_issue.outputs.issue_number }}
      
      - name: Report Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.get_issue.outputs.issue_number }},
              body: '✅ Code Agent finished processing this issue. Check for a new PR!'
            })
      
      - name: Report Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.get_issue.outputs.issue_number }},
              body: '❌ Code Agent encountered an error. Please check the workflow logs.'
            })
