version: "3.9"

services:
  # Webhook server + Worker (all-in-one)
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coding_agent
    ports:
      - "${SERVER_PORT:-8000}:8000"
    environment:
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      # GitHub
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
      # Settings
      DEBUG: ${DEBUG:-true}
      WORKER_INTERVAL: ${WORKER_INTERVAL:-5}
      MAX_FIX_ITERATIONS: ${MAX_FIX_ITERATIONS:-3}
      MAX_ATTEMPTS: ${MAX_ATTEMPTS:-3}
    volumes:
      - ./repos:/app/repos
      - ./db.json:/app/db.json
    restart: unless-stopped
    command: ["run"]

  # Только webhook сервер (без воркера)
  server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coding_agent_server
    ports:
      - "${SERVER_PORT:-8000}:8000"
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_WEBHOOK_SECRET: ${GITHUB_WEBHOOK_SECRET:-}
    volumes:
      - ./repos:/app/repos
      - ./db.json:/app/db.json
    profiles:
      - server-only
    command: ["start-server"]

  # Только воркер (без сервера)
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: coding_agent_worker
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      WORKER_INTERVAL: ${WORKER_INTERVAL:-5}
      MAX_FIX_ITERATIONS: ${MAX_FIX_ITERATIONS:-3}
      MAX_ATTEMPTS: ${MAX_ATTEMPTS:-3}
    volumes:
      - ./repos:/app/repos
      - ./db.json:/app/db.json
    profiles:
      - worker-only
    command: ["start-worker"]
